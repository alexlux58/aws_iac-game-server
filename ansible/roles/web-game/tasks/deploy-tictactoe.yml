---
# Deploy Tic-Tac-Toe game to /tictactoe/ subdirectory
# Simple Tic-Tac-Toe game

- name: Create Tic-Tac-Toe game directory
  ansible.builtin.file:
    path: "{{ web_game_dir }}/tictactoe"
    state: directory
    mode: "0755"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"

- name: Download Tic-Tac-Toe game
  ansible.builtin.get_url:
    url: https://github.com/straker/tic-tac-toe/archive/refs/heads/master.zip
    dest: /tmp/tictactoe-master.zip
    mode: "0644"
  register: game_download
  ignore_errors: yes

- name: Create Tic-Tac-Toe game (inline simple version)
  ansible.builtin.copy:
    content: |
<!DOCTYPE html>
<html>
<head>
    <title>Tic-Tac-Toe</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; }
        .board { display: grid; grid-template-columns: repeat(3, 100px); gap: 5px; margin: 20px auto; width: 310px; }
        .cell { width: 100px; height: 100px; background: white; border: 2px solid #333; font-size: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .cell:hover { background: #e0e0e0; }
        .cell.x { color: #f00; }
        .cell.o { color: #00f; }
        button { padding: 10px 20px; font-size: 16px; margin-top: 20px; }
        .status { font-size: 24px; margin: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Tic-Tac-Toe</h1>
    <div class="status" id="status">Player X's turn</div>
    <div class="board" id="board"></div>
    <button onclick="reset()">Reset Game</button>
    <script>
        let board = Array(9).fill('');
        let currentPlayer = 'X';
        let gameOver = false;
        const status = document.getElementById('status');
        const boardEl = document.getElementById('board');
        function initBoard() {
            boardEl.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                cell.addEventListener('click', () => makeMove(i));
                boardEl.appendChild(cell);
            }
        }
        function makeMove(index) {
            if (board[index] || gameOver) return;
            board[index] = currentPlayer;
            updateBoard();
            if (checkWinner()) {
                status.textContent = `Player ${currentPlayer} wins!`;
                gameOver = true;
            } else if (board.every(cell => cell)) {
                status.textContent = "It's a tie!";
                gameOver = true;
            } else {
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                status.textContent = `Player ${currentPlayer}'s turn`;
            }
        }
        function updateBoard() {
            board.forEach((value, index) => {
                const cell = boardEl.children[index];
                cell.textContent = value;
                if (value) cell.classList.add(value.toLowerCase());
            });
        }
        function checkWinner() {
            const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            return lines.some(line => line.every(i => board[i] === currentPlayer));
        }
        function reset() {
            board = Array(9).fill('');
            currentPlayer = 'X';
            gameOver = false;
            status.textContent = "Player X's turn";
            initBoard();
        }
        initBoard();
    </script>
</body>
</html>
    dest: "{{ web_game_dir }}/tictactoe/index.html"
    mode: "0644"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
  when: game_download is failed or game_download is skipped

- name: Extract Tic-Tac-Toe game (if downloaded)
  ansible.builtin.unarchive:
    src: /tmp/tictactoe-master.zip
    dest: /tmp
    remote_src: true
    creates: /tmp/tic-tac-toe-master
  when: game_download is succeeded

- name: Find extracted Tic-Tac-Toe directory
  ansible.builtin.shell: |
    find /tmp -maxdepth 1 -type d \( -name "*tic*" -o -name "*Tic*" \) | head -1
  register: tictactoe_dir
  changed_when: false
  when: game_download is succeeded

- name: Copy Tic-Tac-Toe game files to game directory
  ansible.builtin.shell: |
    if [ -n "{{ tictactoe_dir.stdout }}" ] && [ -d "{{ tictactoe_dir.stdout }}" ]; then
      find {{ tictactoe_dir.stdout }} -mindepth 1 -maxdepth 1 -exec cp -r {} {{ web_game_dir }}/tictactoe/ \;
      chown -R {{ nginx_user }}:{{ nginx_user }} {{ web_game_dir }}/tictactoe/
      echo "Tic-Tac-Toe files copied successfully"
    fi
  changed_when: true
  when: game_download is succeeded and tictactoe_dir.stdout is defined

